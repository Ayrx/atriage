# flake8: noqa
from atriage.exploitable import parse_exploitable


exploitable_output = """'exploitable' version 1.31
Linux shitweasel 3.16.0-29-generic #39-Ubuntu SMP Mon Dec 15 22:27:29 UTC 2014 x86_64
Signal si_signo: 6 Signal si_addr: 4294967345789
Nearby code:
0x00007ffff6171e27 <+39>:	movsxd rdx,edi
0x00007ffff6171e2a <+42>:	movsxd rsi,esi
0x00007ffff6171e2d <+45>:	movsxd rdi,ecx
0x00007ffff6171e30 <+48>:	mov    eax,0xea
0x00007ffff6171e35 <+53>:	syscall
=> 0x00007ffff6171e37 <+55>:	cmp    rax,0xfffffffffffff000
0x00007ffff6171e3d <+61>:	ja     0x7ffff6171e5d <__GI_raise+93>
0x00007ffff6171e3f <+63>:	repz ret
0x00007ffff6171e41 <+65>:	nop    DWORD PTR [rax+0x0]
0x00007ffff6171e48 <+72>:	test   ecx,ecx
Stack trace:
#  0 __GI_raise at 0x7ffff6171e37 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  1 __GI_abort at 0x7ffff6173528 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  2 __assert_fail_base at 0x7ffff616ace6 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  3 __GI___assert_fail at 0x7ffff616ad92 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  4 None at 0x7ffff6fad93b in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  5 None at 0x7ffff6f5dcd9 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  6 None at 0x7ffff6faf950 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  7 None at 0x7ffff6fb0888 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  8 None at 0x7ffff6f7269f in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  9 None at 0x7ffff6f72bd5 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 10 None at 0x7ffff6f82e9f in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 11 None at 0x7ffff6fb7b4c in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 12 None at 0x7ffff6f7b3c9 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 13 cairo_show_glyphs at 0x7ffff6f6e0a2 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 14 CairoOutputDev::endString at 0x41de99 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 15 Gfx::doShowText at 0x4a08ba in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 16 Gfx::opShowText at 0x4a1ee4 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 17 Gfx::go at 0x48551a in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 18 Gfx::display at 0x487c50 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 19 Page::displaySlice at 0x7e92d8 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 20 renderPage at 0x40e8f4 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 21 main at 0x40e8f4 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
Faulting frame: #  4 None at 0x7ffff6fad93b in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
Description: Abort signal
Short description: AbortSignal (20/22)
Hash: 71c14ffe39944b60af6fd47d1e505f97.0822ff5e99ce7ad4a1e6e98b273082a7
Exploitability Classification: UNKNOWN
Explanation: The target is stopped on a SIGABRT. SIGABRTs are often generated by libc and compiled check-code to indicate potentially exploitable conditions. Unfortunately this command does not yet further analyze these crashes."""


def test_parse_exploitable():
    r = parse_exploitable(exploitable_output)
    assert r.signal_info == "Signal si_signo: 6 Signal si_addr: 4294967345789"
    assert r.disassembly == """0x00007ffff6171e27 <+39>:	movsxd rdx,edi
0x00007ffff6171e2a <+42>:	movsxd rsi,esi
0x00007ffff6171e2d <+45>:	movsxd rdi,ecx
0x00007ffff6171e30 <+48>:	mov    eax,0xea
0x00007ffff6171e35 <+53>:	syscall
=> 0x00007ffff6171e37 <+55>:	cmp    rax,0xfffffffffffff000
0x00007ffff6171e3d <+61>:	ja     0x7ffff6171e5d <__GI_raise+93>
0x00007ffff6171e3f <+63>:	repz ret
0x00007ffff6171e41 <+65>:	nop    DWORD PTR [rax+0x0]
0x00007ffff6171e48 <+72>:	test   ecx,ecx
"""

    assert r.stack_trace == """#  0 __GI_raise at 0x7ffff6171e37 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  1 __GI_abort at 0x7ffff6173528 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  2 __assert_fail_base at 0x7ffff616ace6 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  3 __GI___assert_fail at 0x7ffff616ad92 in /lib/x86_64-linux-gnu/libc-2.19.so (BL)
#  4 None at 0x7ffff6fad93b in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  5 None at 0x7ffff6f5dcd9 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  6 None at 0x7ffff6faf950 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  7 None at 0x7ffff6fb0888 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  8 None at 0x7ffff6f7269f in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
#  9 None at 0x7ffff6f72bd5 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 10 None at 0x7ffff6f82e9f in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 11 None at 0x7ffff6fb7b4c in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 12 None at 0x7ffff6f7b3c9 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 13 cairo_show_glyphs at 0x7ffff6f6e0a2 in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0
# 14 CairoOutputDev::endString at 0x41de99 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 15 Gfx::doShowText at 0x4a08ba in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 16 Gfx::opShowText at 0x4a1ee4 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 17 Gfx::go at 0x48551a in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 18 Gfx::display at 0x487c50 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 19 Page::displaySlice at 0x7e92d8 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 20 renderPage at 0x40e8f4 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
# 21 main at 0x40e8f4 in /home/ben/src/poppler-0.26.5/utils/pdftocairo
"""

    assert r.faulting_frame == "#  4 None at 0x7ffff6fad93b in /usr/lib/x86_64-linux-gnu/libcairo.so.2.11301.0"
    assert r.description == "Abort signal"
    assert r.short_description == "AbortSignal (20/22)"
    assert r.hash_value == "71c14ffe39944b60af6fd47d1e505f97.0822ff5e99ce7ad4a1e6e98b273082a7"
    assert r.exploitability == "UNKNOWN"
    assert r.explanation == "The target is stopped on a SIGABRT. SIGABRTs are often generated by libc and compiled check-code to indicate potentially exploitable conditions. Unfortunately this command does not yet further analyze these crashes."
